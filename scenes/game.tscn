[gd_scene load_steps=11 format=3 uid="uid://b47ts00x6u"]

[ext_resource type="PackedScene" uid="uid://c5q8y2xj3vwqk" path="res://scenes/player/player.tscn" id="1_4h8n2"]
[ext_resource type="PackedScene" uid="uid://bh7m3n4p8qwxr" path="res://scenes/ui/hud.tscn" id="2_3j7k5"]
[ext_resource type="Script" path="res://scripts/systems/enemy_spawner.gd" id="3_enemy"]
[ext_resource type="PackedScene" uid="uid://c8x50a02qwert" path="res://scenes/ui/upgrade_panel.tscn" id="4_upgrade"]
[ext_resource type="Script" path="res://scripts/systems/upgrade_generator.gd" id="5_generator"]
[ext_resource type="Script" path="res://scripts/systems/upgrade_applier.gd" id="6_applier"]
[ext_resource type="PackedScene" uid="uid://ekfe03t6pi02" path="res://scenes/ui/game_over_screen.tscn" id="7_gameover"]
[ext_resource type="PackedScene" uid="uid://beu5p1fu6pi02" path="res://scenes/ui/title_screen.tscn" id="8_title"]
[ext_resource type="PackedScene" path="res://scenes/ui/pause_menu.tscn" id="9_pause"]

[sub_resource type="GDScript" id="GDScript_1"]
script/source = "extends Node2D

## 経過時間
var elapsed_time: float = 0.0
var is_game_running: bool = false

@onready var world_node: Node2D = $WorldNode
@onready var player: Node = $Player
@onready var hud: Node = $HUD
@onready var enemy_spawner: Node = $EnemySpawner
@onready var upgrade_panel: Node = $UpgradePanel
@onready var upgrade_generator: Node = $UpgradeGenerator
@onready var upgrade_applier: Node = $UpgradeApplier
@onready var game_over_screen: Node = $GameOverScreen
@onready var title_screen: Node = $TitleScreen
@onready var pause_menu: Node = $PauseMenu

func _ready() -> void:
	# PoolManagerにworld_nodeを設定
	PoolManager.set_world_node(world_node)

	# PlayerのシグナルをHUDに接続
	player.hp_changed.connect(hud.update_hp)
	player.died.connect(_on_player_died)

	# EnemySpawnerを初期化
	if enemy_spawner != null and player != null:
		enemy_spawner.initialize(player)

	# アップグレードシステムを初期化
	if upgrade_generator != null and player != null:
		upgrade_generator.initialize(player)
	if upgrade_applier != null and player != null:
		upgrade_applier.initialize(player)
	if upgrade_panel != null:
		upgrade_panel.upgrade_selected.connect(_on_upgrade_selected)

	# LevelSystemのシグナル接続
	LevelSystem.level_up.connect(_on_level_up)

	# UI画面のシグナル接続
	if title_screen != null:
		title_screen.start_pressed.connect(_on_title_start_pressed)
		title_screen.quit_pressed.connect(_on_title_quit_pressed)
	if game_over_screen != null:
		game_over_screen.retry_pressed.connect(_on_game_over_retry_pressed)
		game_over_screen.title_pressed.connect(_on_game_over_title_pressed)
	if pause_menu != null:
		pause_menu.resume_pressed.connect(_on_pause_resume_pressed)
		pause_menu.title_pressed.connect(_on_pause_title_pressed)

	# ボスシグナル接続
	BossManager.boss_spawned.connect(_on_boss_spawned)
	BossManager.boss_defeated.connect(_on_boss_defeated)

	# タイトル画面を表示
	_show_title_screen()

func _process(delta: float) -> void:
	# ゲーム時間のカウント（ボス戦中はタイマー停止）
	if is_game_running and GameManager.current_state == GameManager.GameState.PLAYING:
		if BossManager.current_boss == null:
			elapsed_time += delta

func _unhandled_input(event: InputEvent) -> void:
	if event.is_action_pressed(\"pause\"):
		if GameManager.current_state == GameManager.GameState.PLAYING:
			_show_pause_menu()
		elif GameManager.current_state == GameManager.GameState.PAUSED:
			_hide_pause_menu()

## ボス出現時
func _on_boss_spawned(_boss: Node2D) -> void:
	print(\"ボス出現! タイマー停止\")

## ボス撃破時 → ステージクリア
func _on_boss_defeated(_boss: Node2D) -> void:
	if not is_game_running:
		return
	print(\"ボス撃破! ステージクリア: %.1f秒経過\" % elapsed_time)
	is_game_running = false

	# ステージクリア処理
	GameManager.clear_stage()

	# 結果画面を表示（クリア）
	if game_over_screen != null and GameManager.game_stats != null:
		game_over_screen.show_result(GameManager.game_stats, true)

func _on_player_died() -> void:
	if not is_game_running:
		return
	is_game_running = false

	# ゲームオーバー状態に変更
	GameManager.end_game()

	# 結果画面を表示（ゲームオーバー）
	if game_over_screen != null and GameManager.game_stats != null:
		game_over_screen.show_result(GameManager.game_stats, false)

func _on_level_up(new_level: int) -> void:
	print(\"レベルアップ: Lv%d\" % new_level)

	# アップグレード選択肢を生成
	if upgrade_generator != null:
		var options = upgrade_generator.generate_options()
		if upgrade_panel != null:
			upgrade_panel.show_options(options)

func _on_upgrade_selected(option) -> void:
	print(\"アップグレード選択: %s\" % option.display_name)

	# アップグレードを適用
	if upgrade_applier != null:
		upgrade_applier.apply_upgrade(option)

	# ゲームを再開
	GameManager.change_state(GameManager.GameState.PLAYING)

## タイトル画面の開始ボタン
func _on_title_start_pressed() -> void:
	if title_screen != null:
		title_screen.hide_title()
	_start_game()

## タイトル画面の終了ボタン
func _on_title_quit_pressed() -> void:
	get_tree().quit()

## ゲームオーバー画面のリトライボタン
func _on_game_over_retry_pressed() -> void:
	_start_game()

## ゲームオーバー画面のタイトルボタン
func _on_game_over_title_pressed() -> void:
	_show_title_screen()

## ポーズメニューの続けるボタン
func _on_pause_resume_pressed() -> void:
	_hide_pause_menu()

## ポーズメニューのタイトルボタン
func _on_pause_title_pressed() -> void:
	is_game_running = false
	if pause_menu != null:
		pause_menu.hide_menu()
	PoolManager.clear_all_active()
	ComboManager.reset()
	BossManager.reset()
	if enemy_spawner != null:
		enemy_spawner.reset_timer()
	_show_title_screen()

## ポーズメニューを表示
func _show_pause_menu() -> void:
	GameManager.pause_game()
	if pause_menu != null:
		pause_menu.show_menu()

## ポーズメニューを非表示
func _hide_pause_menu() -> void:
	if pause_menu != null:
		pause_menu.hide_menu()
	GameManager.resume_game()

## タイトル画面を表示
func _show_title_screen() -> void:
	if title_screen != null:
		title_screen.show_title()
	if hud != null:
		hud.visible = false
	GameManager.change_state(GameManager.GameState.TITLE)

## ゲーム開始
func _start_game() -> void:
	# 経過時間をリセット
	elapsed_time = 0.0
	is_game_running = true

	# HUDを表示
	if hud != null:
		hud.visible = true

	# プレイヤーをリセット（武器・パワーアップ含む完全リセット）
	if player != null:
		player.reset()
		player.global_position = Vector2(576, 324)

	# EnemySpawnerの難易度タイマーをリセット
	if enemy_spawner != null:
		enemy_spawner.reset_timer()

	# コンボ状態をリセット
	ComboManager.reset()

	# ボス状態をリセット
	BossManager.reset()

	# GameManager経由でゲーム開始（LevelSystem.reset, PoolManager.clear含む）
	GameManager.start_game()
"

[node name="GameScene" type="Node2D"]
script = SubResource("GDScript_1")

[node name="WorldNode" type="Node2D" parent="."]

[node name="Player" parent="." instance=ExtResource("1_4h8n2")]
position = Vector2(576, 324)

[node name="HUD" parent="." instance=ExtResource("2_3j7k5")]
visible = false

[node name="EnemySpawner" type="Node" parent="."]
script = ExtResource("3_enemy")

[node name="UpgradePanel" parent="." instance=ExtResource("4_upgrade")]
visible = false

[node name="UpgradeGenerator" type="Node" parent="."]
script = ExtResource("5_generator")

[node name="UpgradeApplier" type="Node" parent="."]
script = ExtResource("6_applier")

[node name="GameOverScreen" parent="." instance=ExtResource("7_gameover")]
visible = false

[node name="TitleScreen" parent="." instance=ExtResource("8_title")]
visible = false

[node name="PauseMenu" parent="." instance=ExtResource("9_pause")]
visible = false
